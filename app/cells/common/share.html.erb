<div class="share">
  <%= text_field_tag 'share-starter', '', :placeholder => t('share.profile') %>
  <ul class="share-details share-selector" style="display:none;">
    <% if Setting.get(:features, :notes) %>
      <li><%= link_to_function t('share.note'), "selectShare('share-note')", :class => 'comment2-icon', :id => 'share-note-icon' %></li>
    <% end %>
    <% if Setting.get(:features, :pictures) %>
      <li><%= link_to_function t('share.picture'), "selectShare('share-picture')", :class => 'picture-icon', :id => 'share-picture-icon' %></li>
    <% end %>
    <li class="cancel-link"><%= link_to_function '', 'hideShare()', :class =>  'delete-icon' %></li>
  </ul>
  <% if Setting.get(:features, :notes) %>
    <%= form_for Note.new, :html => {:id => 'share-note', :class => 'share-type'},:remote=>true  do |form| %>
      <%= hidden_field_tag :redirect_to, stream_path %>
      <span class="small"><%= t('share.note_label') %></span><br/>
      <%= form.text_area :body, :rows => 2 ,:class=>"share_text",:placeholder => "用@标注你所在位置，用go2 标注出你要去的地方"%><br/>
      <div class="location_info" style="display:none">
        <%= text_field 'marker','geocode_position', :placeholder=>"我的位置",:class=>"marker_geocode_position" %><br>
      </div>
      <%= text_field 'marker','marker_latitude', :type=>'hidden',:class=>"marker_marker_latitude" %>
      <%= text_field 'marker','marker_longitude', :type=>'hidden',:class=>"marker_marker_longitude" %>
      <%= submit_tag t('share.share') %>
      <input class="is_location" title="是否带地理位置，默认为当前位置" type="checkbox" value="1">地理位置
    <% end %>
  <% end %>
  <% if Setting.get(:features, :pictures) %>
    <%= form_for Picture.new, :html => {:multipart => true, :id => 'share-picture', :class => 'share-type'} do |form| %>
      <%= file_field_tag 'pictures[]', :multiple => true %><br/>
      <%= text_field_tag 'album', '', :size => 10, :placeholder => t('share.default_album_name') %><br/>
      <%= text_area_tag "photo_text",'',:class=>"share_text",:size => "40x2", :placeholder => "用@标注你所在位置，用go2 标注出你要去的地方" %><br/>
      <div class="location_info" style="display:none">
        <%= text_field 'marker','geocode_position', :placeholder=>"我的位置",:class=>"marker_geocode_position" %><br>
      </div>
      <%= text_field 'marker','marker_latitude', :type=>'hidden',:class=>"marker_marker_latitude" %>
      <%= text_field 'marker','marker_longitude', :type=>'hidden',:class=>"marker_marker_longitude" %>

      <span class='button' onclick='ajaxFileUpload_file()' ><%= t('share.share') %></span>
      <input class="is_location" title="是否带地理位置，默认为当前位置" type="checkbox" value="1">地理位置
    <% end %>
  <% end %>
  </div>

  <script>
    $(document).ready(function(){

      $("#note_body").change(function(){
        boo = false
        at = $(this).val().match(/.*@(.*)@.*/)
        if(at!= null&&at!=''){
          $(".marker_geocode_position").attr("value", at[1]);
          boo = true
        }
        to = $(this).val().match(/.*go(.*)2.*/)
        if(to!= null&&to!=''){
          $(".marker_destin_position").attr("value", to[1]);
          boo = true
        }
        if(!boo){
          $(".is_location").attr("checked",false)
          $(".marker_geocode_position").attr("value", '');
        }else{
          $(".is_location").attr("checked",true)
          $(".location_info").show();
        }
      
      })
    })
    $(".is_location").change(function(){
      if($(this).attr("checked")==true){
        $(".location_info").show();
        $(".is_location").attr("checked",true)
        if(MapObject.myLocation){
          $(".marker_geocode_position").attr("value",  MapObject.myLocation_address);
          $(".marker_marker_latitude").attr("value",  MapObject.myLocation.lat );
          $(".marker_marker_longitude").attr("value",  MapObject.myLocation.lng);
        }

      }else{
        $(".location_info").hide();
        $(".marker_geocode_position").attr("value", '');
        $(".marker_marker_latitude").attr("value",  "");
        $(".marker_marker_longitude").attr("value",  "");
      }
      
    })
      
    $(".marker_geocode_position").change(function(){
      if($(this).attr("value")!=MapObject.myLocation_address){
        $(".marker_marker_latitude").attr("value",  "");
        $(".marker_marker_longitude").attr("value",  "");
      }else{
        if(MapObject.myLocation){
          $(".marker_marker_latitude").attr("value",  MapObject.myLocation.lat);
          $(".marker_marker_longitude").attr("value",  MapObject.myLocation.lng);
        }

      }
    })
      

    $("#share-note").submit(function(){  
      var options = {   
        url:$(this).attr("action"), //提交给哪个执行  
        type:'POST',
        beforeSubmit:function(formData, jqForm, options){
         
        },
        success:function(){
          $("#location_info").hide();
        }
      };
      $('#share-note').ajaxSubmit(options);   
           
      return false; //为了不刷新页面,返回false，反正都已经在后台执行完了，没事！  
    }
  );
  
  
    function ajaxFileUpload_file(){
      url = ""
      if($(".is_location").attr("checked") ==true){
        url = "?album="+$("#album").val() +"&photo_text="+$("#photo_text").val()+
          "&marker[geocode_position]="+$(".marker_geocode_position").val()+
          "&marker[marker_latitude]="+$(".marker_marker_latitude").val()+
          "&marker[marker_longitude]="+$(".marker_marker_longitude").val()
      }else{
      url = "?album="+$("#album").val() +"&photo_text="+$("#photo_text").val()
      }
     
      $.ajaxFileUpload({
        url:'/pictures/'+url,
        secureuri:false,
        dataType: 'json',
        fileElementId:'pictures_',
        success: function (data,status){
          if(data && data.success==true){
            $("#notice").html(data.notice)
            $("#notice").show()
            $('#notice').fadeOut(15000);
            $("#share-picture").resetForm();
            $("#marker_geocode_position").attr("value", '');
            $("#marker_destin_position").attr("value", '')
            for (var i=0;i<=data.html.length-1;i++) {
              $.ajax({                                                
                type: "GET",                                    
                url: "/pictures/get_stream_item",
                data:"pic_id="+data.html[i].pic_id+"&marker_id="+data.html[i].marker_id,
                success: function(){}
              });
            }
          }else{
            alert("文件保存失败1")
          }
        },
        error: function (data, status, e){
          alert(data.success)
          alert("文件保存失败2")
        }
      })
      return false;
    }
  
  
  
  </script>
  <%= javascript_include_tag "extend/ui" %>
  <div id="temp_hide_album_html">
    <div class="stream-item album stream_album stream_mine">
      <div class="stream-item-meta">
        <span class="nowrap">
          <a href="/people/1">
          <img src="/system/development/people/photos/1/tn/7b1bd75c64dc71867a3afa663ea0f4b6.jpg?1314706499" alt="李文静（管理员） ">
          </a>
        </span>

        <div style="clear: left;"></div>
      </div>
      <div class="stream-item-body">
        <h3>
          <a href="/albums/1">李文静（管理员） </a>
        </h3>
        <div class="nowrap stream-item-timestamp">
          5 分钟 前
          by <a href="/people/1">李文静（管理员） </a>
        </div>
        <div id="pic_share"><div id="triggers"><a title="点击放大" href="/albums/1/pictures/137"><img title="点击放大" src="/system/development/pictures/photos/137/large/776118c8b11d2c20d26c2f5ad8075a90.jpg?1316783217" rel="#mies137" class="stream-pic" alt="点击放大"></a><div id="mies137" class="simple_overlay"><a class="close" style=""></a><img title="点击放大" src="/system/development/pictures/photos/137/original/776118c8b11d2c20d26c2f5ad8075a90.jpg?1316783217" alt="点击放大"></div></div></div>
        <div class="new-comment">
          <a onclick="$('#new-comment-for-89').show(); $(this.parentNode).css('visibility', 'visible');; return false;" href="#" class="discreet small comment-icon">添加评论</a>
          <a style="margin-left: 270px;" onclick="$('#new-comment-for-89').hide(); return false;" href="#" class="delete-icon"></a>
          <div style="display: none;" id="new-comment-for-89">
            <form method="post" id="new_comment" class="new_comment" action="/comments" accept-charset="UTF-8" style=""><div style="margin: 0pt; padding: 0pt; display: inline-block;"><input type="hidden" value="✓" name="utf8" style="display: inline;"><input type="hidden" value="AzxqC/UdT9givBi6ef/f7it1+tr8FT4T69ta4AXIx9U=" name="authenticity_token"></div>
                <input type="hidden" value="137" name="picture_id" id="picture_id">
                <input type="hidden" value="/stream" name="return_to" id="return_to">
                <textarea rows="3" name="text" id="new_comment_textarea" cols="40"></textarea><br>
                <input type="submit" value="保存评论" name="commit" id="comment_submit">
                </form>        </div>
                </div>
                </div>
                </div>
                </div>